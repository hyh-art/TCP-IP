# 数据包首部
每经过一个分层，就会对发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址及协议的相关信息。

以现实中的一个例子为例，假设甲给乙发送电子邮件，内容为“早上好”，从计算机A发送给计算机B.

## 发送数据包的过程

1.应用程序处理  

启动应用程序发送新建邮件，将收件人邮箱填好，再由键盘输入邮件内容“早上好”，鼠标点击发送就可以开始TCP-IP的通信了。
首先，应用程序会进行编码处理，例如，日本电子邮件会进行UTF-8进行编码。这些编码相当于OSI的表示层功能。
`注意：应用程序在发送邮件的那一刻起建立TCP连接，从而利用这个TCP连接发送数据，它的过程首先是将应用的数据发送到下一层的TCP,再做实际的转发处理。`

2.TCP模块的处理  

TCP根据应用的指示，负责建立连接，发送数据以及断开连接。TCP提供将应用层的数据顺利发送至对端的可靠传输。
该功能具体实现过程：
`需要在应用程数据的前端加一个TCP首部，TCP首部包括源端口号以及目标端口号，序号，以及校验和（校验和用来判断数据是否被损害），随后将TCP首部的包再发送给IP。`

3.IP模块的处理  

IP将TCP传过来的TCP首部和TCP数据合起来当做自己的数据，并在TCP,并在TCP首部的前端加上自己的IP首部。因此，IP数据包的IP首部后面紧跟着TCP首部，然后才是应用的数据首部和数据本身。IP首部中包含接收端IP地址以及发送端IPd地址。紧随着IP首部的还有用来判断其后面数据是TCP还有UDP的信息。
IP包生成后，参考路由控制表决定接受此IP包的路由或者主机。随后，IP包将被发送给连接这些路由器或者主机网络接口的驱动程序，以实现真正的发送数据。
如果还不知道接收端的MAC地址，可以利用ARP查找。只要知道了对端的mac地址和IP地址，就可以将mac地址和Ip地址交给以太网的驱动程序，实现数据传输。

4.网络接口（以太网驱动）的处理  

从Ip传过来的IP包，对于以太网驱动来说不过是数据，给这数据附加上以太网首部进行发送处理。以太网首部包含接收端的MAC地址，发送端MAC地址以及标志以太网类型的以太网数据的协议。
根据上述信息产生的以太网数据包将通过物理层传输给接收端。发送处理中的FCS由硬件计算，添加到包的最后。
`设置FCS的目的是为了判断数据包是否由于噪声而被破坏`

## 经过数据链路的包
包流动时，从前往后依次被附加了以太网包首部，IP包首部，TCP包首部（UDP包首部）以及应用自己的包首部和数据。而包的最后则追加以太网包尾。
每个包首部包含什么信息？
一个是发送端和接收端地址，另一个是上一层的协议类型。
`注意：经过每一个协议分层，都必须有识别包发送端和接收端的信息。以太网会用mac地址，IP会用Ip地址，TCP/UDP则会用端口号作为识别两端主机的地址`
此外每一个分层的包首部还包含一个识别位，该识别为的作用是用来识别上一层协议的种类信息。例如以太网的包首部的以太网类型，Ip中的协议类型，以及TCP/UDP中的两个端口号等都起着识别协议类型的作用。

## 数据包接收处理
包的接收过程是发送流程的逆序过程
5.网络接口的处理  

主机收到以太网包以后，首先从以太网的包首部找到MAC地址判断是否为发送给自己的包。如果不是自己的包则丢弃数据。
如果接收到的数据恰好是发送给自己的包，就查找以太网首部的类型域从而确定以太网协议所发送过来的数据类型。在这个例子中数据类型显然是IP包，如果这时候不是IP而是诸如其它ARP协议，就把数据传给ARP处理

6.IP模块的处理  

IP模块收到IP包首部及后面的数据以后，也会做类似的处理。如果判断得到的包首部的IP地址和自己的IP地址匹配，则接收数据并从中查找上一层的协议。如果上一层是TCP就将IP包首部之后的部分传给TCP处理，如果是UDP则将IP包首部传递给UDP处理。对于有路由器的情况下，接收端的地址往往不是自己的地址。此时，需要借助路由控制表，在调查应该送达的主机或者路由器以后再转发数据。

7.TCP模块的处理  

在TCP模块首先会计算一下校验和，判断数据是否被破坏，然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序。
数据接收完毕后，接收端会发送一个“确认回执”给发送端。如果这个回执信息未能达到发送端，那么发送端会认为接收端没有接收到数据而一直发送。

8.应用程序的处理  

接收端应用程序会直接接收发送端的数据。通过解析数据可以获知邮件的收件人地址是乙的地址，如果主机B没有乙的邮件信箱，那么主机B返回给发送端一个“无此收件地址”的报错信息
如果主机B正好有乙的收件箱，所以主机B和收件人乙能够收到电子邮件的正文，邮件会被保存到本机上。
